# Cockroach video parse



## 中文名：爬行轨迹追逐昆虫视频处理程序

### 1 Introduction

To pack an exe: pyinstaller -F [-n *filename*] main.py

![interface02](.\src\img\interface02.jpg)

界面功能介绍：

1. 输入输出控制：
   - 导入视频：从本地导入要处理的视频文件
   - 提取闪光：从视频中提取一个固定的二极管的闪光时刻
   - 查看结果：视频处理结果，要先提取闪光和右侧选择处理视频之后再查看结果
   - 退出：退出程序。下次再进入程序需要重新导入视频
2. 展示控制：
   - 展示第一帧：将视频的第一帧显示出来，同时保存于本地（文件名为视频名+'.jpg'）。用于查看视频和后续处理背景图。
   - 转换单位/取消转换单位：切换输出单位为cm/px，默认为px
3. 处理控制：
   - 处理的缩放倍数：在处理时先将每一帧进行缩放之后再处理。
   - frame skip：跳帧读取。这两种方法可以用户调整速度和精度上的平衡
4. 提取方法控制：
   - 有四种不同的识别方法，它们的特点和适合的应用场景见[3](### 3)
   - 提取过程展示/关闭提取过程展示：提取过程展示是用来可视化提取过程，检验提取方法的有效性的。



处理流程：

`导入视频 -> 提取闪光 -> 设置控制 -> 检测过程 -> 查看结果`



输入和输出：

1. 程序流输入：
- 要处理的视频文件，格式可以是mp4, MOV等等(待测试)。
- 在轮廓识别方法（新版已经取消）中，传入背景图
- 在处理过程中，可能需要手动选择初始框/选择点/选择点颜色/选择标志点选框等等。请按照提示操作。

2. 控制输入：
- 在进行识别结果缩放（即将单位从px对应到cm）的时候，传入蟑螂的实际长度(单位: cm)和蟑螂前后点的位置。
- 设置识别过程中的参数：
  1. 设置跳帧读取
  2. 设置处理过程中的缩放倍数：先进行缩放，再进行识别。一次来达到速度和精度的平衡选择。

1. 处理结果输出：

   - 点击"查看结果"后，可以选择查看轨迹、角度变化、角速度变化。
   - 轨迹输出整体图像、根据刺激分段的图像。在文件内写入中心点坐标随时间变化的所有信息。
   - 角度变化输出根据刺激分段的图像、整体插值图像(标有刺激开始和结束)。在文件内写入倾斜角度随时间变化的所有信息。
   - 角速度变化输出根据角度计算的中心角速度和根据前后点计算出的摆动角速度（如果识别过程中记录了前后点的位置信息）。不向文件写入信息
   - 以上所有图像都输出到`./fig`文件目录下，所有文件都输出到`./result`文件目录下。
   - 以上在处理结果阶段输出的数据是对单位(即是否使用转换单位)敏感的。

2. 检测过程中的输出：

- 提取闪光过程中，会输出`out-light-every.txt`，记录了所有刺激（灯亮）的帧序号。
- 在meanshift、color、feature这三种方法中，记录到昆虫的前、后两点的信息。输出`out-{methodName}-{1/2}.txt`，1代表前点，2代表后点。输出的是前点/后点的每一帧的位置信息。此外，feature方法还会额外记录辅助角度信息（在这两个文件之中）。
- 在camshift、contour、contourCNN这三种方法中，直接记录昆虫的中心点位置、倾斜角度信息。输出`out-{methodName-{center/theta}.txt}`，分别代表记录每一帧的中心点、倾斜角度信息。

3. 其他输出：

- 主窗口中选择"展示第一帧"，程序在显示第一帧的同时，保存原文件名+`.png`第一帧图像到软件主目录。
- 主屏幕上会显示视频的宽和高、总帧数、帧率

### 2 Quick Start

python main.py


### 3 how to process(methods)

| method      | 速度 | 精度 | 识别标志点 | 重新定位 |
| :--:        | :--: | :--: | :--:     | :--:    |
| meanshift   | 快   | 较高 | yes | ok | 
| color       | 较快 | 较高 | yes | ok |
| camshift    | 快   | 较高 | no  | ok |
| contour     | 较慢 | 一般 | no  | ok |
| contourCNN  | 较快 | 较高 | no  | ok |
| feature     | 较慢 | 高   | yes | 困难 |

各种处理方法实现方式及应用场景：

1. menashift：使用cv2自带的meanshift方法，对选框进行目标追踪
2. color：适用于标志点和周围环境和昆虫的颜色有较大差异时。根据一定的颜色范围过滤，得到标志点的位置
3. camshift：使用cv2自带的camshift算法，对选框进行目标追踪。与meanshift不同的是，camshift还可以对选框进行旋转，进而输出角度信息。camshift的选框是整个昆虫，不再依赖于标志点
4. contour：第一步，将每一帧图像转为灰度图，之后与背景图相减。第二步，用sobel算子或者其他算子提取出轮廓信息。第三步，筛选亮度大于阈值的点。第四步，根据这些点计算出蟑螂的中心点位置和倾斜角度。这里倾角计算用到的是线性回归，中心点位置是根据所有距离上一次中心不大于一定阈值的所有点的外包矩形的中心位置计算的。
5. contourCNN：识别过程的前两步与contour相同，第三步将轮廓信息图输出CNN当中，直接输出中心店坐标和倾角。
6. feature：标志点特征识别。适用于标志点有黑白相间的明显特征（建议是十字、叉子等）的情形。根据标志点选框，转为灰度图之后，根据亮度计算得到特征卷积核(kernal)，之后对每一帧

### 4 how to deal data(assessments)

1. 角度的计算：对于识别前后标志点型，用前后标志点间连线的倾角作为蟑螂的倾角。或者直接识别得到倾角
2. 曲率半径的计算：对于轨迹上任意相邻三点，作一条圆弧，对应半径...
3. 角速度的计算：中心角速度：相邻角度除以时间间隔；摆动角速度：相邻两帧之间的前点、后点位移的斜率（倾角）除以时间间隔，对前点、后点分别计算，之后前后点计算得到的角速度直接相加，再减去二倍的中心角速度。
4. 角度插值的计算：对角度变化曲线进行插值，得到角度，求一阶导数得到角速度

### 5 输入输出文件解析
1. 视频输入由opencv-python库中的VideoCapture函数读取。通常支持的文件格式有AVI、MP4、MOV。
2. 输出文件有两种。一种是格式一定的txt文件，另一种是matplotlib生成的图像直接保存的png格式的图像。
3. 所有处理过程的结果都有保存到磁盘()
4. 

> 是否考虑保存svg？
>
> 之前没有选择保存svg的原因是在打包成exe的过程中出错

### 6 注意事项
1. 由于本软件中的color, feature, contour检测方法用到了滑动窗口来提高检测的速度，所以在用这些方法检测是，蟑螂的移动速度有上限。如果超过这个上限，很可能会出现检测异常的情况。普遍来说，上限为20px/frame，也就是说，每帧之间蟑螂的水平或竖直方向的移动距离不应超过20px。（注意要考虑到跳读、处理视频缩放造成的影响）。另外，这个参数是编程可调的。

2. 本软件中对于“一次刺激”有着自己的定义。在每一次刺激的前0.5s和到后4.5s的时间段，称为一次刺激。对于输入的视频，本软件可以提取出每一次刺激的帧序号。对于一次刺激的说明如下：

   > 出现一次刺激的判断标准为：在某一次二极管闪烁的前0.5s内（或：前0.5\*fps 帧内）未检测到二极管闪烁，在后0.5s内，检测到重复出现二极管闪烁的，即为一次刺激。两次刺激的间隔至少为0.5s。

3. 


### 7 异常处理

### 8 可调参数

### 9 软件展示

### 10 用户体验改进部分

由于软件设计和编写过程中的时间、思考量上的不足，有一些问题尚未解决，也会有很多改进的空间。

例如：在选点、选框时应该增加一个双击放大的功能。
